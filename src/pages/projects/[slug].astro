---
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getProjectBySlug, getAllProjects } from '../../lib/content.js'
import RichImage from '../../components/RichImage.astro'
import VideoEmbed from '../../components/VideoEmbed.astro'
import PrototypeEmbed from '../../components/PrototypeEmbed.astro'
import SidebarNav from '../../components/SidebarNav.astro'
import ProjectHero from '../../components/ProjectHero.astro'

export async function getStaticPaths() {
const projects = await getAllProjects()
return projects.map((p) => ({ params: { slug: p.slug } }))
}

const { slug } = Astro.params
const data = await getProjectBySlug(slug)
if (!data) {
throw new Error(`Project not found: ${slug}`)
}
const { module, frontmatter } = data
const { title = slug, subtitle = '', sidebarSections = [], role, period, tools, highlights } = frontmatter

// ä½¿ç”¨é¡¹ç›®é…ç½®çš„sidebarSectionsï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
const sections = sidebarSections.length > 0 ? sidebarSections : [
  { id: 'overview', title: 'Overview' },
  { id: 'motivation', title: 'ğŸ’¡ Motivation' },
  { id: 'project-scope', title: 'âœ¨ Project Scope' },
  { id: 'what-i-worked-on', title: 'ğŸŒˆ What I worked on' },
  { id: 'who-i-worked-with', title: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘ Who I worked with' },
  { id: 'impact', title: 'ğŸ“¸ Impact' },
  { id: 'process-overview', title: 'Process Overview' },
  { id: 'key-research-questions', title: 'Key Research Questions' },
  { id: 'research-methods', title: 'Research Methods' },
  { id: 'log-analysis', title: 'Log Analysis' },
  { id: 'user-interview', title: 'User Interview' },
  { id: 'strategic-recommendations', title: 'Strategic Recommendations' },
  { id: 'personal-reflections', title: 'Personal Reflections' }
]
---
<BaseLayout title={`${title} â€” Portfolio`} hideThemeToggle={false}>
  <!-- Hero Header -->
  <ProjectHero 
    title={title}
    subtitle={subtitle}
    slug={slug}
  />
  
  <!-- ä¸»è¦å†…å®¹ -->
  <article class={`prose prose-neutral dark:prose-invert max-w-none main-content ${slug === 'referral-research' ? 'referral-theme' : slug === 'growth-tactics' ? 'growth-theme' : slug === 'annual-satisfaction' ? 'satisfaction-theme' : slug === 'RAI-product' ? 'rai-theme' : ''}`}>
    <!-- Project Content -->
    <module.default components={{ RichImage, VideoEmbed, PrototypeEmbed }} />
  </article>
  
  <!-- æµ®çª—å¯¼èˆª -->
  <div class="floating-nav-container">
    <SidebarNav sections={sections} theme={slug === 'referral-research' ? 'referral-theme' : slug === 'growth-tactics' ? 'growth-theme' : slug === 'annual-satisfaction' ? 'satisfaction-theme' : slug === 'RAI-product' ? 'rai-theme' : ''} />
  </div>
</BaseLayout>

<style>
  .main-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  
  /* ç§»åŠ¨ç«¯ç¡®ä¿å†…å®¹ä¸è¶…å‡ºå±å¹• */
  @media (max-width: 768px) {
    .main-content {
      padding: 0 1rem;
      max-width: 100%;
      overflow-x: hidden;
    }
  }
  
  .floating-nav-container {
    position: fixed;
    top: 50%;
    left: 2rem;
    transform: translateY(-50%);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .floating-nav-container.visible {
    opacity: 1;
    visibility: visible;
  }
  
  @media (max-width: 1200px) {
    .floating-nav-container {
      left: 1rem;
    }
  }
  
  @media (max-width: 1024px) {
    .floating-nav-container {
      position: static;
      transform: none;
      margin: 2rem auto 0;
      max-width: 300px;
      opacity: 1;
      visibility: visible;
    }
    
    .main-content {
      padding: 0 1rem;
    }
  }
</style>

<script>
  // æµ®çª—å¯¼èˆªæ˜¾ç¤ºæ§åˆ¶
  function initFloatingNav() {
    const floatingNav = document.querySelector('.floating-nav-container');
    if (!floatingNav) return;
    
    let isVisible = false;
    let hideTimeout;
    let hasScrolled = false; // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²æ»šåŠ¨
    
    // æ˜¾ç¤ºæµ®çª—
    function showNav() {
      clearTimeout(hideTimeout);
      if (!isVisible) {
        floatingNav.classList.add('visible');
        isVisible = true;
      }
    }
    
    // éšè—æµ®çª—
    function hideNav() {
      hideTimeout = setTimeout(() => {
        floatingNav.classList.remove('visible');
        isVisible = false;
      }, 5000); // å»¶é•¿åˆ°5ç§’
    }
    
    // é¼ æ ‡è¿›å…¥é¡µé¢æ—¶æ˜¾ç¤º - åªæœ‰åœ¨ç”¨æˆ·æ»šåŠ¨åæ‰è§¦å‘
    document.addEventListener('mousemove', (e) => {
      if (hasScrolled && e.clientX < 200) { // å·¦ä¾§200pxåŒºåŸŸè§¦å‘ï¼Œä½†éœ€è¦å…ˆæ»šåŠ¨
        showNav();
      } else if (hasScrolled) {
        hideNav();
      }
    });
    
    // æ»šåŠ¨æ—¶æ˜¾ç¤º - æ›´æ•æ„Ÿ
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      hasScrolled = true; // æ ‡è®°ç”¨æˆ·å·²å¼€å§‹æ»šåŠ¨
      showNav();
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        hideNav();
      }, 6000); // å»¶é•¿åˆ°6ç§’
    });
    
    // ç§»åŠ¨ç«¯å§‹ç»ˆæ˜¾ç¤º
    if (window.innerWidth <= 1024) {
      floatingNav.classList.add('visible');
    }
  }
  
  document.addEventListener('DOMContentLoaded', initFloatingNav);
  
  // Slideæ»šåŠ¨åŠ¨ç”»æ§åˆ¶
  function initSlideAnimations() {
    const slideImages = document.querySelectorAll('.slide-image-large');
    if (slideImages.length === 0) return;
    
    // åˆ›å»ºIntersection Observer
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // æ·»åŠ å»¶è¿Ÿï¼Œè®©åŠ¨ç”»æ›´æµç•…
          setTimeout(() => {
            entry.target.classList.add('visible');
          }, 100);
        }
      });
    }, {
      threshold: 0.1, // å½“å…ƒç´ 10%å¯è§æ—¶è§¦å‘
      rootMargin: '0px 0px -50px 0px' // æå‰50pxè§¦å‘
    });
    
    // è§‚å¯Ÿæ‰€æœ‰slideå›¾ç‰‡
    slideImages.forEach((slide) => {
      observer.observe(slide);
    });
  }
  
  // åˆå§‹åŒ–slideåŠ¨ç”»
  document.addEventListener('DOMContentLoaded', initSlideAnimations);
</script>