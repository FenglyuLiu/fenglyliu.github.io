---
// ä¸åŒéšç§çº§åˆ«çš„è¿½è¸ªé…ç½®
// è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº†ä¸‰ç§ä¸åŒçš„è¿½è¸ªç­–ç•¥
---

<!-- æ–¹æ¡ˆ1ï¼šå®Œå…¨åŒ¿åè¿½è¸ªï¼ˆæ— éœ€åŒæ„ï¼‰ -->
<script>
  // å®Œå…¨åŒ¿åè¿½è¸ªé…ç½® - ä¸æ”¶é›†ä»»ä½•ä¸ªäººæ ‡è¯†ä¿¡æ¯
  const ANONYMOUS_TRACKING_CONFIG = {
    enabled: true,
    // ä¸æ”¶é›†ç”¨æˆ·IDã€ä¼šè¯IDç­‰æ ‡è¯†ä¿¡æ¯
    collectUserInfo: false,
    collectSessionInfo: false,
    // åªæ”¶é›†é¡µé¢çº§åˆ«çš„åŒ¿åæ•°æ®
    collectPageData: true,
    collectTechnicalData: true,
    collectBehaviorData: true
  };

  // åŒ¿åè¿½è¸ªæ•°æ®
  let anonymousData = {
    pageViews: [],
    events: [],
    technicalInfo: {
      screenResolution: `${screen.width}x${screen.height}`,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      language: navigator.language,
      userAgent: navigator.userAgent
    }
  };

  function trackAnonymousPageView(pagePath = window.location.pathname) {
    const pageData = {
      path: pagePath,
      title: document.title,
      timestamp: Date.now(),
      loadTime: performance.now(),
      scrollDepth: 0,
      timeOnPage: 0
    };

    anonymousData.pageViews.push(pageData);
    saveAnonymousData();
  }

  function trackAnonymousEvent(eventType, data) {
    const eventData = {
      type: eventType,
      data: data,
      timestamp: Date.now(),
      page: window.location.pathname
    };

    anonymousData.events.push(eventData);
    saveAnonymousData();
  }

  function saveAnonymousData() {
    try {
      localStorage.setItem('anonymous_tracking', JSON.stringify(anonymousData));
    } catch (error) {
      console.log('åŒ¿åæ•°æ®ä¿å­˜å¤±è´¥:', error);
    }
  }
</script>

<!-- æ–¹æ¡ˆ2ï¼šæœ€å°åŒ–è¿½è¸ªï¼ˆæ— éœ€åŒæ„ï¼‰ -->
<script>
  // æœ€å°åŒ–è¿½è¸ªé…ç½® - åªæ”¶é›†å¿…è¦çš„ç½‘ç«™åˆ†ææ•°æ®
  const MINIMAL_TRACKING_CONFIG = {
    enabled: true,
    // åªæ”¶é›†èšåˆæ•°æ®ï¼Œä¸è¿½è¸ªä¸ªäººè¡Œä¸º
    collectAggregateData: true,
    collectPersonalData: false,
    // æ•°æ®è‡ªåŠ¨è¿‡æœŸ
    dataRetentionDays: 7
  };

  let minimalData = {
    dailyStats: {},
    pageStats: {},
    lastUpdated: Date.now()
  };

  function trackMinimalStats() {
    const today = new Date().toISOString().split('T')[0];
    const currentPage = window.location.pathname;
    
    // æ›´æ–°æ¯æ—¥ç»Ÿè®¡
    if (!minimalData.dailyStats[today]) {
      minimalData.dailyStats[today] = {
        pageViews: 0,
        uniquePages: new Set(),
        totalTime: 0
      };
    }
    
    minimalData.dailyStats[today].pageViews++;
    minimalData.dailyStats[today].uniquePages.add(currentPage);
    
    // æ›´æ–°é¡µé¢ç»Ÿè®¡
    if (!minimalData.pageStats[currentPage]) {
      minimalData.pageStats[currentPage] = {
        views: 0,
        avgTime: 0
      };
    }
    
    minimalData.pageStats[currentPage].views++;
    minimalData.lastUpdated = Date.now();
    
    saveMinimalData();
  }

  function saveMinimalData() {
    try {
      // æ¸…ç†è¿‡æœŸæ•°æ®
      const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      Object.keys(minimalData.dailyStats).forEach(date => {
        if (new Date(date).getTime() < sevenDaysAgo) {
          delete minimalData.dailyStats[date];
        }
      });
      
      localStorage.setItem('minimal_tracking', JSON.stringify(minimalData));
    } catch (error) {
      console.log('æœ€å°åŒ–æ•°æ®ä¿å­˜å¤±è´¥:', error);
    }
  }
</script>

<!-- æ–¹æ¡ˆ3ï¼šå®Œå…¨è¿½è¸ªï¼ˆéœ€è¦åŒæ„ï¼‰ -->
<script>
  // å®Œå…¨è¿½è¸ªé…ç½® - éœ€è¦ç”¨æˆ·æ˜ç¡®åŒæ„
  const FULL_TRACKING_CONFIG = {
    enabled: false, // é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦ç”¨æˆ·åŒæ„
    collectUserInfo: true,
    collectSessionInfo: true,
    collectPersonalData: true,
    collectBehaviorData: true,
    dataRetentionDays: 30
  };

  // æ£€æŸ¥ç”¨æˆ·åŒæ„çŠ¶æ€
  function checkConsent() {
    const consent = localStorage.getItem('tracking_consent');
    if (consent === 'accepted') {
      FULL_TRACKING_CONFIG.enabled = true;
      return true;
    } else if (consent === 'declined') {
      FULL_TRACKING_CONFIG.enabled = false;
      return false;
    } else {
      // é¦–æ¬¡è®¿é—®ï¼Œæ˜¾ç¤ºåŒæ„æç¤º
      showConsentModal();
      return false;
    }
  }

  function showConsentModal() {
    // åˆ›å»ºåŒæ„æ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; margin: 1rem;">
          <h3 style="margin-bottom: 1rem;">æ•°æ®æ”¶é›†åŒæ„</h3>
          <p style="margin-bottom: 1.5rem; color: #666;">
            æˆ‘ä»¬æ”¶é›†åŒ¿åæ•°æ®æ¥æ”¹å–„ç½‘ç«™ä½“éªŒã€‚è¿™äº›æ•°æ®ä¸ä¼šè¯†åˆ«æ‚¨çš„èº«ä»½ï¼Œä»…ç”¨äºåˆ†æç›®çš„ã€‚
          </p>
          <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button id="decline-tracking" style="padding: 0.5rem 1rem; border: 1px solid #ccc; background: white; border-radius: 4px;">
              æ‹’ç»
            </button>
            <button id="accept-tracking" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px;">
              æ¥å—
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('accept-tracking').addEventListener('click', () => {
      localStorage.setItem('tracking_consent', 'accepted');
      FULL_TRACKING_CONFIG.enabled = true;
      document.body.removeChild(modal);
      initializeFullTracking();
    });
    
    document.getElementById('decline-tracking').addEventListener('click', () => {
      localStorage.setItem('tracking_consent', 'declined');
      FULL_TRACKING_CONFIG.enabled = false;
      document.body.removeChild(modal);
    });
  }

  function initializeFullTracking() {
    if (FULL_TRACKING_CONFIG.enabled) {
      // åˆå§‹åŒ–å®Œæ•´è¿½è¸ªåŠŸèƒ½
      console.log('å®Œæ•´è¿½è¸ªå·²å¯ç”¨');
    }
  }
</script>

<!-- æ–¹æ¡ˆ4ï¼šæ— è¿½è¸ªæ¨¡å¼ -->
<script>
  // æ— è¿½è¸ªæ¨¡å¼ - å®Œå…¨ä¸æ”¶é›†ä»»ä½•æ•°æ®
  const NO_TRACKING_CONFIG = {
    enabled: false,
    collectAnyData: false,
    useGoogleAnalytics: false
  };

  function disableAllTracking() {
    // ç¦ç”¨æ‰€æœ‰è¿½è¸ªåŠŸèƒ½
    localStorage.setItem('tracking_consent', 'declined');
    localStorage.removeItem('tracking_data');
    localStorage.removeItem('visitor_analytics');
    localStorage.removeItem('anonymous_tracking');
    localStorage.removeItem('minimal_tracking');
    
    console.log('æ‰€æœ‰è¿½è¸ªåŠŸèƒ½å·²ç¦ç”¨');
  }
</script>

<!-- éšç§çº§åˆ«é€‰æ‹©å™¨ -->
<div id="privacy-level-selector" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
  <button onclick="showPrivacyOptions()" style="background: #007bff; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">
    ğŸ”’
  </button>
</div>

<script>
  function showPrivacyOptions() {
    const options = document.createElement('div');
    options.innerHTML = `
      <div style="position: fixed; bottom: 80px; right: 20px; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1001;">
        <h4 style="margin-bottom: 1rem;">éšç§è®¾ç½®</h4>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button onclick="setPrivacyLevel('anonymous')" style="padding: 0.5rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
            ğŸŸ¢ åŒ¿åè¿½è¸ªï¼ˆæ— éœ€åŒæ„ï¼‰
          </button>
          <button onclick="setPrivacyLevel('minimal')" style="padding: 0.5rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
            ğŸŸ¡ æœ€å°åŒ–è¿½è¸ªï¼ˆæ— éœ€åŒæ„ï¼‰
          </button>
          <button onclick="setPrivacyLevel('full')" style="padding: 0.5rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
            ğŸ”´ å®Œæ•´è¿½è¸ªï¼ˆéœ€è¦åŒæ„ï¼‰
          </button>
          <button onclick="setPrivacyLevel('none')" style="padding: 0.5rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
            âš« æ— è¿½è¸ª
          </button>
        </div>
        <button onclick="closePrivacyOptions()" style="margin-top: 1rem; padding: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
          å…³é—­
        </button>
      </div>
    `;
    
    document.body.appendChild(options);
  }

  function setPrivacyLevel(level) {
    switch(level) {
      case 'anonymous':
        localStorage.setItem('privacy_level', 'anonymous');
        alert('å·²å¯ç”¨åŒ¿åè¿½è¸ªæ¨¡å¼');
        break;
      case 'minimal':
        localStorage.setItem('privacy_level', 'minimal');
        alert('å·²å¯ç”¨æœ€å°åŒ–è¿½è¸ªæ¨¡å¼');
        break;
      case 'full':
        localStorage.setItem('privacy_level', 'full');
        checkConsent();
        break;
      case 'none':
        localStorage.setItem('privacy_level', 'none');
        disableAllTracking();
        alert('å·²ç¦ç”¨æ‰€æœ‰è¿½è¸ª');
        break;
    }
    closePrivacyOptions();
  }

  function closePrivacyOptions() {
    const options = document.querySelector('div[style*="position: fixed; bottom: 80px"]');
    if (options) {
      document.body.removeChild(options);
    }
  }
</script>
